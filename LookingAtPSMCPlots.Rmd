---
title: "TroubleShootingPSMC_01"
author: "Jesse Garcia"
date: "10/23/2018"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
```


Reading in data
```{r}
directories<-list.dirs("../data/PSMCTroubleshooting/")

##There's "dupCor" folders. To not include them include the "$". This is yings file structure. 
directories<-directories %>% str_subset("inputFiles$")
#If not Empirical, simulated
empirical<-directories %>% str_detect("/Qlob_PSMC/inputFiles|/Qrob_PSMC/inputFiles")
species<-directories %>% str_extract("Q[a-z]*")
model<-directories %>% str_extract("Q[a-z]*\\.psmc\\.[a-zA-Z0-9+.-]*|Q[a-z]*")
 
df<-tibble(
  directories=directories,
  empirical=empirical,
  species=species,
  model=model
)
df$files<-df$directories %>% map(~list.files(.x, full.names = T))
df<-df %>% unnest(files)
df$files<-df$files %>% map(~read_delim(file=.x, delim="\t", col_names = F)) 
df <- df %>% 
  unnest(files) %>%
  dplyr::rename(Chr=X1, PositionOfSegregating=X2, NumberOfCalledSitesSinceLastSegregating=X3, PhasedAlleles=X4)







```



## Are there differences between Number Of Called Sites Since Last Segregating Position
- Visually, it looks like the simulated chromosomes have larger IBS. 
_ Ying's PSMC' Results suggest that the empirical data has recent declines. Opposite of what I'd expect I think. 
- There should be longer tracts in populations that have smaller Ne. 

```{r pressure}
df %>% 
  ggplot(aes(x=model, y=log10(NumberOfCalledSitesSinceLastSegregating), colour=empirical)) + 
  geom_boxplot() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_grid(~ species)
```


## Is the difference in medians 
-Yeah, but not what we expected. Expected Q Lobata Empirical median to b e the smallest. 


```{r}
df %>% 
  group_by(model, species, empirical) %>%
  summarise(mean=mean(NumberOfCalledSitesSinceLastSegregating), median=median(NumberOfCalledSitesSinceLastSegregating)) %>%
  ggplot(aes(x=model, y=median, colour=empirical)) + 
  geom_point() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~ species)
```
## Is the difference in means

```{r}
df %>% 
  group_by(model, species, empirical) %>%
  summarise(mean=mean(NumberOfCalledSitesSinceLastSegregating), median=median(NumberOfCalledSitesSinceLastSegregating)) %>%
  ggplot(aes(x=model, y=mean, colour=empirical)) + 
  geom_point() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~ species)
```

## Differences in density?


```{r}
df %>% 
  ggplot(aes(colour=model, x=NumberOfCalledSitesSinceLastSegregating)) + 
  geom_density() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~ species)
```

## How about if we log things


```{r}
df %>% 
  ggplot(aes(colour=model, x=log(NumberOfCalledSitesSinceLastSegregating))) + 
  geom_density() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~ species)
```

## Seperating by species. Appears logging things works 
```{r}

df %>%
  filter(species=="Qlob") %>%
  ggplot(aes(colour=model, x=log(NumberOfCalledSitesSinceLastSegregating))) + 
  geom_density() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_wrap(~ species)

```



```{r}
plot<-df %>% 
  ggplot(aes(x=model, y=NumberOfCalledSitesSinceLastSegregating, colour=empirical)) + 
  geom_boxplot() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_grid(~ species) + 
  labs(y="IBS Lengths")
```

## Caveats, pitfalls, and best practices. 
- Time Discretization
    - Finer Discretization leads to a more accurate approximation. Will increase runtimes. 







